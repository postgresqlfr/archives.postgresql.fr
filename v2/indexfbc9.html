
<!DOCTYPE
 html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
 <html>
 <!-- $Date: 2005/08/30 07:54:43 $ / $Revision: 1.29 $ / Last Theme Editor :$Author: jx $-->
  
<!-- Mirrored from drupal.postgresql.fr/?q=node/1378 by HTTrack Website Copier/3.x [XR&CO'2006], Sun, 12 Oct 2008 16:30:57 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<base  />
<style type="text/css" media="all">@import "misc/drupal.css";</style>
   <title>Index invers√©, en C - PostgreSQLFr</title>
 <style type="text/css" media="screen" title="Normal Text">
    @import url("layout/css/blue/fixed.css");
    @import url(_guillaume/dotclear/themes/postgresql/style.html);
 </style>
 <style type="text/css" media="screen" title="Normal Text2">
    @import url("layout/css/blue/pgfr.css");
    @import url(_guillaume/dotclear/themes/postgresql/style.html);
 </style>
   </head>
   <body>
    <table border="0" cellspacing="5" cellpadding="0" width="100%">
     <tr>
      <!--td colspan="2" width="100%"-->
      <td colspan="2">
      <!-- Head -->
       <table border="0" cellspacing="0" cellpadding="0" width="100%">
        <tr>
	 <td align="left">
           <div id="pgHeader">
	    <div id="pgHeaderLogoLeft">
	     <a href="index.html" title="PostgreSQL"><img src="layout/images/hdr_left.png" width="230" height="80" alt="PostgreSQL" /></a>
	    </div>
	    <div id="pgHeaderLogoRight">
	     <a href="index.html" title="La base de donnÈes la plus sophistiquÈe au monde."><img src="layout/images/hdr_right.png" width="210" height="80" alt="La base de donnÈes la plus sophistiquÈe au monde." /></a>
	    </div>
	   </div>
         </td>
	 <td align="right">
         </td>
	</tr>
      </table> <!-- Head -->
      <br />
      <table border="0" cellspacing="0" cellpadding="0" width="100%">
              <tr>
	      	 <td align="left">

		<div class="pgTopNav">
		   <div class="pgTopNavLeft"> 
		     <img src="layout/images/nav_lft.png" width="7" height="23" alt="" />
		   </div>
		   <div class="pgTopNavRight">
		    <img src="layout/images/nav_rgt.png" width="7" height="23" alt="" />
		  </div>
		  <!--<ul class="pgTopNavList">-->
		  <ul class="pgTopNavList">
		   <li><a href="index03d2.html?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="indexf6e5.html?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="index71c4.html?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>

		   <li> <a href="indexf6fe.html?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="index79b7.html?q=forum">forums</a> </li>
		   <li> <a href="index729f.html?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="index4404.html?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>

		  </ul>

<!--
		   <li><a href="?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>
		   <li> <a href="?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="?q=forum">forums</a> </li>
		   <li> <a href="?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>
-->
		  </ul>
	        </div>
		</td>
		</tr>
		</table>
      </td>
     </tr>
     <tr>
    <td style="vertical-align: top; width: 20%;">
<div class="block block-user" id="block-user-0">
<div class="pgSideNav">    <h2>Ouverture de session</h2>    
		    <div>
			<form action="http://drupal.postgresql.fr/?q=user/login" method="post">
<div class="user-login-block">
<input type="hidden" name="edit[destination]" value="node/1378" />
<div class="form-item">
 <label for="edit-name">Nom d'utilisateur:</label><br />
 <input type="text" maxlength="64" class="form-text" name="edit[name]" id="edit-name" size="15" value="" />
</div>
<div class="form-item">
 <label for="edit-pass">Mot de passe:</label><br />
 <input type="password" class="form-password" maxlength="64" name="edit[pass]" id="edit-pass" size="15" value="" />
</div>
<input type="submit" class="form-submit" name="op" value="Identification"  />
</div>

</form>
<div class="item-list"><ul><li><a href="indexc12c.html?q=user/password" title="Demander un nouveau mot de passe par e-mail.">Demander un nouveau mot de passe</a></li></ul></div>
		    </div></div></div>
<div class="block block-user" id="block-user-1">
<div class="pgSideNav">    <h2>Navigation</h2>    
		    <div>
			<div class="menu">
<ul>
<li class="leaf"><a href="indexa499.html?q=tracker">messages r√©cents</a></li>

</ul>
</div>
		    </div></div></div>
<div class="block block-block" id="block-block-4">
<div class="pgSideNav">    <h2>Contactez-nous</h2>    
		    <div>
			<p><strong>Administration du site&nbsp;:</strong><br />
"equipe chez postgresqlfr point org"<br><br />
<strong>Contact presse&nbsp;:</strong><br />
"fr chez postgresql point org"<br><br />
<strong>Contact association&nbsp;:</strong><br />
"bureau chez postgresqlfr point org"<br><br />
<strong>Questions PostgreSQL&nbsp;:</strong><br />
&nbsp;IRC&nbsp;:<br />
&nbsp;&nbsp;serveur <strong>irc.freenode.net</strong><br />
&nbsp;&nbsp;canal <strong>#postgresqlfr</strong></p>

		    </div></div></div>
<div class="block block-block" id="block-block-1">
<div class="pgSideNav">    <h2>Liens</h2>    
		    <div>
			<p><small></p>
<ul>
<li>
<a href="http://www.postgresqlfr.org/?q=node/view/162">Adh√©rer</a>
</li>
<li>
<a href="http://www.postgresqlfr.org/?q=node/473">Faire un don</a>
</li>
<li>
<a href="http://www.postgresqlfr.org/?q=node/163">Consulter les statuts</a>
</li>
</ul>
<ul>
<li>
<a href="http://www.postgresql.org/" class="active">Site original<br />
</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/" class="active">Site de traduction</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.3/">Doc v.8.3.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.2/">Doc v.8.2.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.1/">Doc v.8.1.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.0/">Doc v.8.0.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/7.4/">Doc v.7.4.x fr</a>
</li>
<li>
<a href="http://www.postgis.fr/">PostGIS</a>
</li>
<li>
<a href="http://www.postgresql.org/docs/techdocs">Techdocs</a>
</li>
<li>
<a href="http://www.varlena.com/varlena/GeneralBits/Tidbits/">General TidBits</a>
</li>
<p><!--</p>
<li>
<a href="http://www.postgresqlfr.org/?q=node/view/58">Version Windows</a>
</li>
<p>--></p>
<li>
<a href="http://www.postgresqlfr.org/drupal/?q=node/view/63">T√©moignages de pros</a>
</li>
<li>
<a href="http://archives.postgresql.org/pgsql-fr-generale/">Liste de diffusion</a>
</li>
<li>
<a href="http://wwwmaster.postgresql.org/download/mirrors-ftp">T√©l√©charger</a>
</li>
</ul>
<p></small></p>

		    </div></div></div>
<div class="block block-block" id="block-block-2">
<div class="pgSideNav">    <h2>Recherche</h2>    
		    <div>
			<form action="http://drupal.postgresql.fr/?q=search" method="post">
<div id="search">
<input class="form-text" type="text" size="15" value="" name="keys" alt="Enter the terms you wish to search for." /><br />
<input class="form-submit" type="submit" value="Recherche" />
</div>
</form>

		    </div></div></div>
<div class="block block-forum" id="block-forum-0">
<div class="pgSideNav">    <h2>Sujets du forum</h2>    
		    <div>
			<div class="item-list"><h3>Sujets actifs</h3><ul><li><a href="index253f.html?q=node/1742">A LIRE : FERMETURE DES FORUMS DRUPAL</a></li><li><a href="indexfc2e.html?q=node/1739" title="2 commentaires">Probl√®me  avec pg_dump</a></li><li><a href="index97c1.html?q=node/1731" title="5 commentaires">Connexions simultann√©es</a></li><li><a href="index32d3.html?q=node/1737" title="1 commentaire">Optimisation de la m√©moire sous PostgreSQL</a></li><li><a href="index2483.html?q=node/1736" title="3 commentaires">[R√©solu] Upgrade Postgre -> types et op√©rateurs</a></li></ul></div><div class="item-list"><h3>Nouveaux sujets:</h3><ul><li><a href="index253f.html?q=node/1742">A LIRE : FERMETURE DES FORUMS DRUPAL</a></li><li><a href="indexfc2e.html?q=node/1739" title="2 commentaires">Probl√®me  avec pg_dump</a></li><li><a href="index32d3.html?q=node/1737" title="1 commentaire">Optimisation de la m√©moire sous PostgreSQL</a></li><li><a href="index2483.html?q=node/1736" title="3 commentaires">[R√©solu] Upgrade Postgre -> types et op√©rateurs</a></li><li><a href="index82c4.html?q=node/1734" title="2 commentaires">[RESOLU] Probleme de connection en odbc</a></li></ul></div><div class="more-link"><a href="index79b7.html?q=forum" title="Lire les derniers sujets.">en lire plus</a></div>
		    </div></div></div>
<div class="block block-archive" id="block-archive-0">
<div class="pgSideNav">    <h2>Acc√©der aux archives</h2>    
		    <div>
			
<!-- calendar -->
<div class="calendar"><table summary="Un calendrier pour acc√©der aux archives.">
 <caption><a href="index9dfb.html?q=archive/2008/09/12" title="Mois pr√©c√©dent">&laquo;</a> Octobre 2008 &nbsp;</caption>
 <tr class="header-week">
 <th abbr="Lundi">Lun</th>
 <th abbr="Mardi">Mar</th>
 <th abbr="Mercredi">Mer</th>
 <th abbr="Jeudi">Jeu</th>
 <th abbr="Vendredi">Ven</th>
 <th abbr="Samedi">Sam</th>
 <th abbr="Dimanche">Dim</th>
</tr>
 <tr class="row-week"><td class="day-blank" colspan="2">&nbsp;</td>
  <td class="day-link"><a href="indexd3e2.html?q=archive/2008/10/1">1</a></td>
  <td class="day-normal">2</td>
  <td class="day-normal">3</td>
  <td class="day-normal">4</td>
  <td class="day-normal">5</td>
 </tr>
 <tr class="row-week">
  <td class="day-normal">6</td>
  <td class="day-normal">7</td>
  <td class="day-normal">8</td>
  <td class="day-normal">9</td>
  <td class="day-normal">10</td>
  <td class="day-normal">11</td>
  <td class="day-today">12</td>
 </tr>
 <tr class="row-week">
  <td class="day-future">13</td>
  <td class="day-future">14</td>
  <td class="day-future">15</td>
  <td class="day-future">16</td>
  <td class="day-future">17</td>
  <td class="day-future">18</td>
  <td class="day-future">19</td>
 </tr>
 <tr class="row-week">
  <td class="day-future">20</td>
  <td class="day-future">21</td>
  <td class="day-future">22</td>
  <td class="day-future">23</td>
  <td class="day-future">24</td>
  <td class="day-future">25</td>
  <td class="day-future">26</td>
 </tr>
 <tr class="row-week">
  <td class="day-future">27</td>
  <td class="day-future">28</td>
  <td class="day-future">29</td>
  <td class="day-future">30</td>
  <td class="day-future">31</td>
  <td class="day-blank" colspan="2">&nbsp;</td>
 </tr>
</table></div>


		    </div></div></div>
<div class="block block-node" id="block-node-0">
<div class="pgSideNav">    <h2>Syndication</h2>    
		    <div>
			<div class="xml-icon"><a href="index9637.html?q=rss.xml"><img src="misc/xml.png" width="36" height="14" alt="Flux XML" title="Flux XML" /></a></div>
		    </div></div></div>
<div class="block block-poll" id="block-poll-0">
<div class="pgSideNav">    <h2>Sondage</h2>    
		    <div>
			<div class="poll"><div class="title">Quelle est la version de PostgreSQL la plus r√©pandue sur vos serveurs ?</div><div class="text">8.3</div><div class="bar"><div style="width: 10%;" class="foreground"></div></div><div class="percent">10%</div><div class="text">8.2</div><div class="bar"><div style="width: 42%;" class="foreground"></div></div><div class="percent">42%</div><div class="text">8.1</div><div class="bar"><div style="width: 40%;" class="foreground"></div></div><div class="percent">40%</div><div class="text">8.0</div><div class="bar"><div style="width: 2%;" class="foreground"></div></div><div class="percent">2%</div><div class="text">7.4</div><div class="bar"><div style="width: 6%;" class="foreground"></div></div><div class="percent">6%</div><div class="text">7.3 ou ant√©rieure</div><div class="bar"><div style="width: 0%;" class="foreground"></div></div><div class="percent">0%</div><div class="total">Nombre de votes: 48</div></div><div class="links"><a href="index8c57.html?q=node/1426#comment" title="Sauter au premier commentaire de ce message.">3 commentaires</a> | <a href="index729f.html?q=poll" title="Voir la liste des sondages de ce site.">anciens sondages</a></div>
		    </div></div></div>
    </td>

      <td style="vertical-align: top; width: 80%"><div class="breadcrumb"><a href="index03d2.html?q=">Accueil</a></div><h2 class="title">Index invers√©, en C</h2>
<!-- begin content -->

<!-- node: "Index invers√©, en C" -->
<!--<div class="pgFrontCenterUser">
<div class="pgFrontUser">
<div class="pgFrontUserInner">
--><div class="pgFrontUserWrap">
 <div class="pgFrontUserContent">	<h1 class="plop"> | <a href="indexfbc9.html?q=node/1378" class="active">Index invers√©, en C</a></h1>
		    <p>
			    Par <a href="indexc818.html?q=user/3" title="Voir le profil utilisateur.">Guillaume Lelarge</a> le 05/09/2007 - 18:33
		    </p>	
			    <p>Depuis la version 8i, Oracle impl√©mente les index invers√©s. Voici une proposition d‚Äôimpl√©mentation √©quivalente pour PostgreSQL. Les index invers√©s permettent d‚Äôacc√©l√©rer les recherches sur les motifs tels que ¬´ colonne LIKE '%cha√Æne' ¬ª. Dans un tel cas, PostgreSQL effectue un parcours s√©quentiel (ou ¬´ sequential scan ¬ª) de la table interrog√©e. Toutefois, il est possible d‚Äô√©muler un index inverse au moyen d‚Äôune fonction de renversement de cha√Æne coupl√©e √† un index sur fonction.</p>
<p>L'<a href="http://www.postgresqlfr.org/?q=node/1329" hreflang="fr">article pr√©c√©dent</a> proposait l'impl√©mentation d'un prototype en langage proc√©dural PL/pgSQL, qui fait office ici de prototype. Cette impl√©mentation a pour principal d√©faut d'√™tre lente, p√©nalisant ainsi gravement les performances en √©criture (INSERT et UPDATE). Ainsi, √† chaque mise √† jour, il est n√©cessaire de faire appel √† la fonction <code>reverse</code> pour mettre √† jour l'index fonctionnel ; cela s'observe notamment √† la cr√©ation de l'index. En revanche, il est possible de tirer partie des capacit√©s de traitement des caract√®res multi-octets, que l'on rencontre notamment dans le cas d'une base de donn√©es encod√©e en UTF-8.</p>
<p>Ainsi, l'impl√©mentation en langage C se doit d'√™tre √† la fois plus rapide et surtout se doit de supporter les jeux de caract√®res multi-octets. C'est √† partir de ce minuscule cahier des charges que nous allons construire notre fonction <code>reverse</code>.<a href="http://doxygen.postgresql.org/c_8h-source.html#l00395" hreflang="en"></a></p>
<h1>Pourquoi √©crire une proc√©dure stock√©e en C</h1>
<p>Pourquoi s'emb√™ter √† prendre le temps d'√©crire une proc√©dure stock√©e en langage C alors qu'il est possible de faire la m√™me chose en langage PL/pgSQL&nbsp;?<br />
Il y a plusieurs r√©ponses √† cette question&nbsp;:</p>
<ul>
<li>Une fonction C permet de <strong>prot√©ger le code</strong>. En effet, rien n'interdit √† un utilisateur poss√©dant les droits n√©cessaires de modifier la proc√©dure stock√©e que l'on a √©crite et valid√© par une autre proc√©dure de son crue, rendant le syst√®me inop√©rant.</li>
<li>Si le besoin de cr√©er son propre type de donn√©es se fait sentir, le passage par la case <q>fonction C</q> est obligatoire.</li>
<li>La satisfaction de conna√Ætre un peu mieux le fonctionnement interne de PostgreSQL, mais c'est surtout une satisfaction de geek :)</li>
<li>La probl√©matique de la <strong>vitesse</strong> est toutefois le facteur d√©terminant de la r√©√©criture d'une fonction d'un langage proc√©dural interpr√©t√© en langage compil√©.</li>
</ul>
<p>Le gain significatif de vitesse ne sera pas √©vident pour les requ√™tes de s√©lection. En revanche, les √©critures (surtout INSERT et UPDATE) peuvent √™tre fortement p√©nalis√©es par le co√ªt de la mise √† jour d'un index fonctionnel. Bien que cela ne soit pas √©vident pour une op√©ration unitaire, il sera parfaitement visible dans le cas d'une op√©ration d'√©criture en masse (chargement massif de donn√©es), ou tout simplement pour la cr√©ation de l'index fonctionnel. Dans un tel cas, l'option d'une r√©√©criture en langage C est √† envisager tr√®s s√©rieusement.</p>
<h1>Impl√©mentation et discussion technique</h1>
<p>Les possibilit√©s d'extension de PostgreSQL s‚Äôappuient sur les m√©canismes de chargement dynamique de biblioth√®que du syst√®me d‚Äôexploitation. L‚Äôinterface de programmation est relativement simple, √† condition d‚Äôen conna√Ætre certaines cl√©s.</p>
<h2>Structure du projet</h2>
<p>Le projet est articul√© autour de diff√©rents fichiers, qui seront tous plac√©s dans un r√©pertoire d√©di√© :</p>
<ol>
<li>un fichier <code>Makefile</code> simplifi√©, utilisant PGXS, l'infrastructure de construction d'extension PostgreSQL ;</li>
<li>un mod√®le de script SQL d'installation <code>reverse.sql.in</code> ;</li>
<li>un fichier <code>uninstall_reverse.sql</code> ;</li>
<li>le fichier source en langage C, <code>reverse.c</code>.</li>
</ol>
<h2>Fichiers annexes</h2>
<p>Avant toute chose, il faut disposer d‚Äôun fichier ¬´ Makefile ¬ª de construction du module externe&nbsp;:</p>
<p class="code">
MODULES = reverse<br />
#PG_CPPFLAGS = -ggdb<br />
DATA_built = reverse.sql<br />
DATA = uninstall_reverse.sql<br />
PGXS := $(shell pg_config --pgxs)<br />
include $(PGXS)
</p>
<p>Le Makefile utilise ici l‚Äôoutil PGXS qui propose un fichier Makefile pr√©d√©fini, √† l‚Äôinstar des fichiers Makefile fournis par Oracle.</p>
<p>Le fichier ¬´ reverse.sql.in ¬ª qui sert de mod√®le √† la cr√©ation du fichier d'installation de l'extension ¬´ <code>reverse.sql</code> ¬ª. Ce dernier fichier sera g√©n√©r√© √† partir du mod√®le en rempla√ßant ¬´ <code>MODULE_PATHNAME</code> ¬ª par le chemin complet du fichier objet g√©n√©r√©.</p>
<p class="code">
-- D√©claration de la fonction reverse en tant que module C<br />
SET search_path = public;<br />
CREATE OR REPLACE FUNCTION reverse(varchar) RETURNS varchar<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS 'MODULE_PATHNAME', 'reverse'<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LANGUAGE 'C' IMMUTABLE STRICT;
</p>
<p>Le script ¬´ reverse.sql ¬ª sera ex√©cut√© par un utilisateur PostgreSQL ayant le r√¥le d‚Äôadministrateur, les fonctions C √©tant consid√©r√©es comme non-s√ªres et donc de la responsabilit√© de l‚Äôadministrateur.</p>
<p>Un script de d√©sinstallation ¬´ uninstall_reverse.sql ¬ª est √©galement pr√©vu, √ßa fait toujours plaisir&nbsp;:</p>
<p class="code">
SET search_path = public;<br />
DROP FUNCTION reverse(varchar);
</p>
<h2>Un peu de technique</h2>
<p>La lecture de la page ¬´ Fonctions en langage C ¬ª permet d‚Äôobtenir les informations n√©cessaires au d√©veloppement d‚Äôune fonction C, voir la documentation ¬´ <a href="http://docs.postgresqlfr.org/8.2/xfunc-c.html" hreflang="fr">Fonctions en langage C</a> ¬ª. Cependant la lecture des fichiers d‚Äôen-t√™tes permet d‚Äôapporter un √©clairage suppl√©mentaire sur certaines structures de donn√©es.</p>
<h3>Traitement des cha√Ænes de caract√®res avec PostgreSQL</h3>
<p>Sous PostgreSQL, les cha√Ænes de caract√®res ne sont pas d√©limit√©es par un caract√®re nul ¬´ <code>\0</code> ¬ª terminal, mais, √† l‚Äôinstar du langage Pascal, en stockant dans une structure d‚Äôabord sa longueur puis son contenu. Une telle cha√Æne est d√©crite dans une structure de type ¬´ <code>varlena</code> ¬ª. Ce type de donn√©es offre en fait un moyen uniforme de stocker tout type de donn√©es √† longueur variable, comme les cha√Ænes de caract√®res, les tableaux ou encore les types utilisateurs.</p>
<p>Voici sa d√©finition, obtenu dans le fichier d'en-t√™te <a href="http://doxygen.postgresql.org/c_8h-source.html#l00395" hreflang="en">c.h</a>, √† la ligne 409 :</p>
<p class="code">
struct varlena<br />
{<br />
&nbsp;&nbsp;&nbsp;&nbsp;int32       vl_len_;      /* Do not touch this field directly! */<br />
&nbsp;&nbsp;&nbsp;&nbsp;char        vl_dat[1];<br />
};
</p>
<p>Ainsi, l'entier <code>vl_len</code> contient la longueur, en octets, de la cha√Æne d'octets <code>vl_dat</code>.</p>
<p>Quelques macros permettent de manipuler facilement cette structure.</p>
<ul>
<li><code>VARDATA(<em>varlena</em>)</code> obtient un pointeur sur la donn√©e ;</li>
<li><code>VARSIZE(<em>varlena</em>)</code> obtient la taille en octets de la structure varlena (<code>vl_len + vl_dat</code>) ;</li>
<li>la constante <code>VARHDRSZ</code> repr√©sente la taille en octet de <code>vl_len</code> ;</li>
<li>Enfin, <code>VARATT_SIZEP</code>, remplac√©e par <code>SET_VARSIZE</code> √† partir de la 8.3, permet de d√©finir la longueur en octets de la donn√©e.</li>
</ul>
<p>Ainsi, pour obtenir la longueur en octets de la donn√©es, on utilisera <code>(VARSIZE - VARHDRSZ)</code>.</p>
<h3>Support des jeux de caract√®res multi-octets</h3>
<p>L'impl√©mentation propos√©e supporte les jeux de caract√®res multi-octets, comme l'UTF8 (ou Unicode) et les jeux de caract√®res asiatiques, qui repr√©sente certains caract√®res sous la forme d'une s√©quence de deux octets ou plus (voir r√©f√©rence). PostgreSQL met √† disposition des fonctions utiles pour manipuler les cha√Ænes de caract√®res, peu importe l'encodage, notamment <code>pg_verifymbstr</code> qui valide une cha√Æne de caract√®re selon l'encodage de la base de donn√©es, ou encore <code>pg_mblen</code> qui donne la longueur en octets d'un caract√®re. Pour le prototype des fonctions cit√©es et d'autres fonctions, se r√©f√©rer au fichier d'en-t√™te ¬´ <code>mb/pg_wchar.h</code> ¬ª.</p>
<h3>Les conventions d'appel</h3>
<p>Il existe deux conventions d'appel de fonctions externes&nbsp;:</p>
<ol>
<li>La convention d'appel version 0, repr√©sentant l'ancien style, simple √† utiliser ;</li>
<li>La convention d'appel version 1, qui est la norme dor√©navant et qui ne pr√©sente pas de difficult√©s particuli√®res.</li>
</ol>
<p>La convention d'appel version 1 sera utilis√©e dans le but de donner d'entr√©e de jeu de bonnes habitudes. La complexit√© de cette convention est masqu√©e par une batterie de macros qui rendent son utilisation tout aussi simple, voire encore plus simple que la version 0, notamment pour le passage d'arguments.</p>
<h2>Impl√©mentation en langage C</h2>
<p>Le source C est structur√© en quatre parties&nbsp;:</p>
<ul>
<li>L‚Äôinclusion des fichiers d‚Äôen-t√™tes n√©cessaires ;</li>
<li>La d√©finition d‚Äôun ¬´ magic ¬ª signant un module externe PostgreSQL ;</li>
<li>La d√©finition d‚Äôun ¬´ magic ¬ª d√©clarant la fonction reverse √† PostgreSQL ;</li>
<li>Le corps de fonction reverse, cette fois en langage C.</li>
</ul>
<p>Voici ci-apr√®s, le code source en langage C de la fonction reverse.</p>
<p class="code">
/*<br />
 * reverse procedural function<br />
 *<br />
 * Thomas Reiss, 12/07/2007 ‚Äì 24/07/2007 - 02/08/2007<br />
 * Alain Delorme, 24/07/2007<br />
 * Merci √† depesz pour ses tests sur la version 8.3devel<br />
 *<br />
 */<br />
&nbsp;<br />
#include &quot;pg_config.h&quot;<br />
#include &quot;postgres.h&quot;<br />
#include &quot;fmgr.h&quot;<br />
&nbsp;<br />
#include &quot;mb/pg_wchar.h&quot;<br />
#include &quot;utils/elog.h&quot;<br />
&nbsp;<br />
#ifdef PG_MODULE_MAGIC<br />
PG_MODULE_MAGIC;<br />
#endif<br />
&nbsp;<br />
Datum<br />
reverse(PG_FUNCTION_ARGS);<br />
&nbsp;<br />
// SET_VARSIZE correspond √† la nouvelle API, nous d√©finissons cette<br />
// macro pour les versions ne la poss√©dant pas.<br />
#ifndef SET_VARSIZE<br />
#define SET_VARSIZE(n,s) VARATT_SIZEP(n) = s;<br />
#endif<br />
&nbsp;<br />
/* fonction reverse */<br />
PG_FUNCTION_INFO_V1(reverse);<br />
Datum<br />
reverse(PG_FUNCTION_ARGS)<br />
{<br />
&nbsp;&nbsp;&nbsp;&nbsp;int len, pos = 0;<br />
&nbsp;&nbsp;&nbsp;&nbsp;VarChar *str_out, *str_in;<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* Obtient l'adresse de l'argument */<br />
&nbsp;&nbsp;&nbsp;&nbsp;str_in = PG_GETARG_VARCHAR_P_COPY(0);<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* Calcul de la taille en octet de la cha√Æne */<br />
&nbsp;&nbsp;&nbsp;&nbsp;len = (int) (VARSIZE(str_in) - VARHDRSZ);<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* Cr√©er une cha√Æne vide de taille identique */<br />
&nbsp;&nbsp;&nbsp;&nbsp;str_out = (VarChar *)palloc(VARSIZE(str_in));<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* La structure r√©sultante aura une longueur identique */<br />
&nbsp;&nbsp;&nbsp;&nbsp;SET_VARSIZE(str_out, VARSIZE(str_in));<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* V√©rifie que l'encodage de la cha√Æne en argument<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* concorde avec l'encodage de la BDD */<br />
&nbsp;&nbsp;&nbsp;&nbsp;pg_verifymbstr(VARDATA(str_in), len, false);<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* Copie √† l'envers de la cha√Æne */<br />
&nbsp;&nbsp;&nbsp;&nbsp;while (pos &lt; len)<br />
&nbsp;&nbsp;&nbsp;&nbsp;{<br />
&nbsp;&nbsp;&nbsp;&nbsp;int charlen = pg_mblen(VARDATA(str_in) + pos);<br />
&nbsp;&nbsp;&nbsp;&nbsp;int i = charlen;<br />
&nbsp;&nbsp;&nbsp;&nbsp;// Copie un caract√®re.<br />
&nbsp;&nbsp;&nbsp;&nbsp;// !! Un caract√®re != un octet<br />
&nbsp;&nbsp;&nbsp;&nbsp;while (i--)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(VARDATA(str_out) + len - charlen + i - pos) = *(VARDATA(str_in) + i + pos);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pos = pos + charlen;     // incr√©mente le compteur<br />
&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;&nbsp;&nbsp;PG_FREE_IF_COPY(str_in, 0);<br />
&nbsp;&nbsp;&nbsp;&nbsp;/* Retourne la copie */<br />
&nbsp;&nbsp;&nbsp;&nbsp;PG_RETURN_VARCHAR_P(str_out);<br />
}
</p>
<h2>Construction</h2>
<p>La construction de l'extension PostgreSQL est r√©alis√©e en invoquant <code>make</code></p>
<p class="code">
tom@clementina:~/src/reverse$ make<br />
cc -g -Wall -O2 -fPIC -Wall -Wmissing-prototypes -Wpointer-arith -Winline -Wdeclaration-after-statement -Wendif-labels -fno-strict-aliasing -g -fpic -I. -I/usr/include/postgresql/8.2/server -I/usr/include/postgresql/internal -D_GNU_SOURCE  -I/usr/include/tcl8.4  -c -o reverse.o reverse.c<br />
cc -shared -o reverse.so reverse.o<br />
rm reverse.o
</p>
<p>Si tout s'est bien pass√©, l'installation sera finalis√©e en ex√©cutant la commande <code>make install</code>, √©ventuellement pr√©c√©d√© de <code>sudo</code> en fonction de sa distribution et de son installation de PostgreSQL.</p>
<p class="code">
tom@clementina:~/src/reverse$ sudo make install<br />
Password: xxxx<br />
/bin/sh /usr/lib/postgresql/8.2/lib/pgxs/src/makefiles/../../config/install-sh -c -m 644 ./reverse.sql '/usr/share/postgresql/8.2/contrib'<br />
 /bin/sh /usr/lib/postgresql/8.2/lib/pgxs/src/makefiles/../../config/install-sh -c -m 755  reverse.so '/usr/lib/postgresql/8.2/lib'
</p>
<p>Les fichiers produits seront ainsi install√©s dans le r√©pertoire d'installation de PostgreSQL. Il est toutefois possible de les positionner ailleurs, √† condition d'adapter le fichier ¬´ <code>reverse.sql</code> ¬ª de fa√ßon √† indiquer √† PostgreSQL<br />
o√π se trouve la biblioth√®que partag√©e (fichier ¬´ <code>reverse.so</code> ¬ª sous Linux).</p>
<h1>Utilisation et performances</h1>
<h2>V√©rification de bon fonctionnement</h2>
<p>Dans un premier temps, on cr√©e la fonction via l'outil <code>psql</code>&nbsp;:</p>
<p class="code">
test=# \i reverse.sql<br />
CREATE FUNCTION
</p>
<p>On v√©rifie que la fonction r√©pond correctement :</p>
<p class="code">
test=# SHOW client_encoding;<br />
 client_encoding<br />
-----------------<br />
 UTF8<br />
(1 ligne)<br />
&nbsp;<br />
test=# SELECT reverse('Cha√Æne √† renverser');<br />
      reverse<br />
--------------------<br />
 resrevner √† en√ÆahC<br />
(1 ligne)
</p>
<p>Ok, √ßa marche, y compris avec les cha√Ænes encod√©es en UTF-8&nbsp;!</p>
<h2>Petit test de performance</h2>
<p>Ce test a √©t√© r√©alis√© par <a href="http://www.depesz.com/" hreflang="en">depesz</a>, qui m'a aimablement autoris√© a le r√©utiliser dans le cadre de cet article.</p>
<p>Petit aper√ßu du jeu de test :</p>
<p class="code">
test=# SELECT count(*),<br />
test-#        min(length(filepath)),<br />
test-#        max(length(filepath)),<br />
test-#        sum(length(filepath))<br />
test-#  FROM test;<br />
count  | min | max |   sum<br />
-------+-----+-----+----------<br />
320136 |   7 | 174 | 18563865<br />
(1 row)
</p>
<p>Maintenant, voici une petite comparaison des trois impl√©mentations, √† savoir le prototype en PL/pgSQL, la version PL/perl de depesz et la version C. On oppose √† ces trois tests un parcours de la table via la fonction d'agr√©gat <a href="http://docs.postgresqlfr.org/8.2/functions-aggregate.html" hreflang="fr">count()</a>, permettant ainsi de mesurer l<em>'overhead</em> due √† chaque impl√©mentation de la fonction <code>reverse</code>. √Ä chaque fois, 3 ex√©cutions permettent de v√©rifier les r√©sultats.</p>
<h3>Simple comptage (count)</h3>
<p>Voici l'ordre SQL utilis√© pour r√©aliser ce test :</p>
<p class="code">
test=# EXPLAIN ANALYZE<br />
test-# SELECT count(filepath)<br />
test-# FROM test;
</p>
<p>Et voici les temps de r√©ponse obtenus&nbsp;:<br />
Ex√©cution #1 : 1269.535 ms<br />
Ex√©cution #2 : 1268.421 ms<br />
Ex√©cution #3 : 1257.926 ms<br />
<strong>Moyenne : 1265,29 ms</strong></p>
<h3>Prototype PL/pgSQL</h3>
<p class="code">
test=# EXPLAIN ANALYZE<br />
test-# SELECT count(reverse_plpgsql(filepath))<br />
test-# FROM test;
</p>
<p>Ex√©cution #1 : 55269.941 ms<br />
Ex√©cution #2 : 56047.004 ms<br />
Ex√©cution #3 : 56149.888 ms<br />
<strong>Moyenne : 55822,28 ms</strong></p>
<h3>Version PL/perl</h3>
<p class="code">
test=# EXPLAIN ANALYZE<br />
test-# SELECT count(text_reverse(filepath))<br />
test-# FROM test;
</p>
<p>Ex√©cution #1 : 4088.625 ms<br />
Ex√©cution #2 : 4089.729 ms<br />
Ex√©cution #3 : 4020.500 ms<br />
<strong>Moyenne : 4066,28 ms</strong></p>
<h3>Version C</h3>
<p class="code">
test=# EXPLAIN ANALYZE<br />
test-# SELECT count(reverse(filepath))<br />
test-# FROM test;
</p>
<p>Ex√©cution #1 : 1596.176 ms<br />
Ex√©cution #2 : 1647.046 ms<br />
Ex√©cution #3 : 1657.531 ms<br />
<strong>Moyenne : 1633,58 ms</strong></p>
<h3>Synth√®se du test de performance</h3>
<p>Voici un graphe faisant la synth√®se des moyennes des temps de r√©ponse&nbsp;:</p>
<p><img src="files/comparaison_plpgsql_plperl_c_count.png" alt="Comparaison des temps de r√©ponse"/></p>
<p>Le graphe suivant permet de mieux se rendre compte de l'overhead induie par l'impl√©mentation PL/perl et l'impl√©mentation C.</p>
<p><img src="files/ccomparaison_plperl_c_count.png" alt="Comparaison des temps de r√©ponse"/></p>
<p>Chose tr√®s int√©ressante&nbsp;: l'overhead pour renverser ~320000 enregistrements est de seulement 300ms, ce qui est bien entendu excellent et laisse pr√©sager de tr√®s bonnes performances quant au co√ªt de la mise √† jour d'un index fonctionnel.</p>
<p>Ainsi, comme cela pouvait √™tre ais√©ment imagin√©, la version C est la plus rapide, suivie par la version PL/Perl. La version PL/pgSQL se tra√Æne lamentablement derri√®re, ce qui justifie compl√®tement la r√©√©criture de la proc√©dure stock√©e en C.</p>
<h1>Notes</h1>
<p>Cette fonction a √©t√© test√© sur une base en PostgreSQL 8.0, 8.2 et 8.3devel (merci √† depesz).</p>
<p>Je regrette de ne pas avoir pu aller un peu plus loin pour le <a href="post/2007/08/20/Fonction-reverse-avec-PostgreSQL-PL/pgSQL.html" hreflang="fr">pr√©c√©dent article</a>, des imp√©ratifs de place m'ayant oblig√© √† aller √† l'essentiel sans montrer les diff√©rents plans d'ex√©cution. Heureusement, l'<a href="http://www.depesz.com/index.php/2007/07/30/indexable-field-like-something/" hreflang="en">article de hubert depesz lubaczewski</a> montre tous les aspects que j'ai n√©glig√©, malheureusement c'est en anglais.</p>
<h1>R√©f√©rences</h1>
<p>De plus amples pr√©cisions sont √©galement disponibles en langue anglaise sur les sites Internet suivant :</p>
<ul>
<li><a href="http://stephane.bpf.st/si/bdd/pg/fnctidx" hreflang="fr">Les index fonctionnels</a></li>
<li><a href="http://docs.postgresqlfr.org/8.2/multibyte.html" hreflang="fr">Support des jeux de caract√®res</a> dans PostgreSQL</li>
<li><a href="http://docs.postgresqlfr.org/8.2/xfunc-c.html" hreflang="fr">Fonctions en langage C</a></li>
<li><a href="http://linuxgazette.net/139/peterson.html" hreflang="en">Writing PostgreSQL Functions in C</a></li>
<li><a href="http://www.varlena.com/GeneralBits/68.php" hreflang="en">What's a Varlena ?</a></li>
<li><a href="http://french.joelonsoftware.com/Articles/Unicode.html" hreflang="fr">Le minimum syndical √† conna√Ætre sur les jeux de caract√®res multi-octets</a></li>
<li><a href="http://www.rfc-ref.org/RFC-TEXTS/3629/index.html" hreflang="en">RFC 3629, UTF-8, a transformation format of ISO 10646</a> ou <a href="ftp://ftp.isi.edu/in-notes/rfc3629.txt" hreflang="en">RFC 3629</a></li>
<li><a href="http://doxygen.postgresql.org/main.html" hreflang="en">Documentation Doxygen du code de PostgreSQL</a></li>
</ul>
<h1>Remerciements</h1>
<p>Je remercie vivement les personnes suivantes&nbsp;:</p>
<ul>
<li>Alain Delorme pour sa contribution,</li>
<li>hubert depesz lubaczewski pour ses retours et tests pr√©liminaires,</li>
<li>Guillaume Lelarge pour ses relectures et ses conseils avis√©s.</li>
</ul>
<p><i>Article √©crit par Thomas Reiss, publi√© sur postgresqlfr.org avec sa permission. Vous pouvez le retrouver sur son <a href="http://blog.frosties.org/">blog o√π il parle encore de PostgreSQL (et d'autres choses :-)</a> ). Merci beaucoup.</i></p>
<table>
 <tr><th>Fichier attach√©</th><th>Taille</th> </tr>
 <tr class="dark"><td><a href="files/comparaison_plpgsql_plperl_c_count.png">comparaison_plpgsql_plperl_c_count.png</a></td><td>15.26 Ko</td> </tr>
 <tr class="light"><td><a href="files/ccomparaison_plperl_c_count.png">ccomparaison_plperl_c_count.png</a></td><td>9.86 Ko</td> </tr>
</table>

		     </div></div>
<!--</div>
</div>
</div>
</div> -->
<a id="comment"></a>
<form method="post" action="http://drupal.postgresql.fr/?q=comment"><div>
<input type="hidden" name="edit[nid]" value="1378" />
</div></form>
<!-- end content -->
              </td>

    </tr>
    <tr><td colspan="2">

		<div class="pgTopNav">
		   <div class="pgTopNavLeft"> 
		     <img src="layout/images/nav_lft.png" width="7" height="23" alt="" />
		   </div>
		   <div class="pgTopNavRight">
		    <img src="layout/images/nav_rgt.png" width="7" height="23" alt="" />
		  </div>
		  <!--<ul class="pgTopNavList">-->
		  <ul class="pgTopNavList">
		   <li><a href="index03d2.html?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="indexf6e5.html?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="index71c4.html?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>

		   <li> <a href="indexf6fe.html?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="index79b7.html?q=forum">forums</a> </li>
		   <li> <a href="index729f.html?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="index4404.html?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>

		  </ul>

<!--
		   <li><a href="?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>
		   <li> <a href="?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="?q=forum">forums</a> </li>
		   <li> <a href="?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>
-->
		  </ul>
	        </div>
    </td></tr>
   </table>
   <p style="text-align: center;">&copy;&nbsp;PostgreSQLFr, tous droits r√©serv√©s.<br>
Site d√©clar√© √† la CNIL sous le num√©ro 1074678, conform√©ment √† la Loi en vigueur.
</p>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-3921927-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>
<p></p>
   
</body>

<!-- Mirrored from drupal.postgresql.fr/?q=node/1378 by HTTrack Website Copier/3.x [XR&CO'2006], Sun, 12 Oct 2008 16:31:03 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>