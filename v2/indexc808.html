
<!DOCTYPE
 html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
 <html>
 <!-- $Date: 2005/08/30 07:54:43 $ / $Revision: 1.29 $ / Last Theme Editor :$Author: jx $-->
  
<!-- Mirrored from drupal.postgresql.fr/?q=node/1379 by HTTrack Website Copier/3.x [XR&CO'2006], Sun, 12 Oct 2008 16:31:14 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<base  />
<style type="text/css" media="all">@import "misc/drupal.css";</style>
   <title>S√©curiser votre base PostgreSQL - PostgreSQLFr</title>
 <style type="text/css" media="screen" title="Normal Text">
    @import url("layout/css/blue/fixed.css");
    @import url(_guillaume/dotclear/themes/postgresql/style.html);
 </style>
 <style type="text/css" media="screen" title="Normal Text2">
    @import url("layout/css/blue/pgfr.css");
    @import url(_guillaume/dotclear/themes/postgresql/style.html);
 </style>
   </head>
   <body>
    <table border="0" cellspacing="5" cellpadding="0" width="100%">
     <tr>
      <!--td colspan="2" width="100%"-->
      <td colspan="2">
      <!-- Head -->
       <table border="0" cellspacing="0" cellpadding="0" width="100%">
        <tr>
	 <td align="left">
           <div id="pgHeader">
	    <div id="pgHeaderLogoLeft">
	     <a href="index.html" title="PostgreSQL"><img src="layout/images/hdr_left.png" width="230" height="80" alt="PostgreSQL" /></a>
	    </div>
	    <div id="pgHeaderLogoRight">
	     <a href="index.html" title="La base de donnÈes la plus sophistiquÈe au monde."><img src="layout/images/hdr_right.png" width="210" height="80" alt="La base de donnÈes la plus sophistiquÈe au monde." /></a>
	    </div>
	   </div>
         </td>
	 <td align="right">
         </td>
	</tr>
      </table> <!-- Head -->
      <br />
      <table border="0" cellspacing="0" cellpadding="0" width="100%">
              <tr>
	      	 <td align="left">

		<div class="pgTopNav">
		   <div class="pgTopNavLeft"> 
		     <img src="layout/images/nav_lft.png" width="7" height="23" alt="" />
		   </div>
		   <div class="pgTopNavRight">
		    <img src="layout/images/nav_rgt.png" width="7" height="23" alt="" />
		  </div>
		  <!--<ul class="pgTopNavList">-->
		  <ul class="pgTopNavList">
		   <li><a href="index03d2.html?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="indexf6e5.html?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="index71c4.html?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>

		   <li> <a href="indexf6fe.html?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="index79b7.html?q=forum">forums</a> </li>
		   <li> <a href="index729f.html?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="index4404.html?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>

		  </ul>

<!--
		   <li><a href="?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>
		   <li> <a href="?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="?q=forum">forums</a> </li>
		   <li> <a href="?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>
-->
		  </ul>
	        </div>
		</td>
		</tr>
		</table>
      </td>
     </tr>
     <tr>
    <td style="vertical-align: top; width: 20%;">
<div class="block block-user" id="block-user-0">
<div class="pgSideNav">    <h2>Ouverture de session</h2>    
		    <div>
			<form action="http://drupal.postgresql.fr/?q=user/login" method="post">
<div class="user-login-block">
<input type="hidden" name="edit[destination]" value="node/1379" />
<div class="form-item">
 <label for="edit-name">Nom d'utilisateur:</label><br />
 <input type="text" maxlength="64" class="form-text" name="edit[name]" id="edit-name" size="15" value="" />
</div>
<div class="form-item">
 <label for="edit-pass">Mot de passe:</label><br />
 <input type="password" class="form-password" maxlength="64" name="edit[pass]" id="edit-pass" size="15" value="" />
</div>
<input type="submit" class="form-submit" name="op" value="Identification"  />
</div>

</form>
<div class="item-list"><ul><li><a href="indexc12c.html?q=user/password" title="Demander un nouveau mot de passe par e-mail.">Demander un nouveau mot de passe</a></li></ul></div>
		    </div></div></div>
<div class="block block-user" id="block-user-1">
<div class="pgSideNav">    <h2>Navigation</h2>    
		    <div>
			<div class="menu">
<ul>
<li class="leaf"><a href="indexa499.html?q=tracker">messages r√©cents</a></li>

</ul>
</div>
		    </div></div></div>
<div class="block block-block" id="block-block-4">
<div class="pgSideNav">    <h2>Contactez-nous</h2>    
		    <div>
			<p><strong>Administration du site&nbsp;:</strong><br />
"equipe chez postgresqlfr point org"<br><br />
<strong>Contact presse&nbsp;:</strong><br />
"fr chez postgresql point org"<br><br />
<strong>Contact association&nbsp;:</strong><br />
"bureau chez postgresqlfr point org"<br><br />
<strong>Questions PostgreSQL&nbsp;:</strong><br />
&nbsp;IRC&nbsp;:<br />
&nbsp;&nbsp;serveur <strong>irc.freenode.net</strong><br />
&nbsp;&nbsp;canal <strong>#postgresqlfr</strong></p>

		    </div></div></div>
<div class="block block-block" id="block-block-1">
<div class="pgSideNav">    <h2>Liens</h2>    
		    <div>
			<p><small></p>
<ul>
<li>
<a href="http://www.postgresqlfr.org/?q=node/view/162">Adh√©rer</a>
</li>
<li>
<a href="http://www.postgresqlfr.org/?q=node/473">Faire un don</a>
</li>
<li>
<a href="http://www.postgresqlfr.org/?q=node/163">Consulter les statuts</a>
</li>
</ul>
<ul>
<li>
<a href="http://www.postgresql.org/" class="active">Site original<br />
</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/" class="active">Site de traduction</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.3/">Doc v.8.3.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.2/">Doc v.8.2.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.1/">Doc v.8.1.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/8.0/">Doc v.8.0.x fr</a>
</li>
<li>
<a href="http://docs.postgresqlfr.org/7.4/">Doc v.7.4.x fr</a>
</li>
<li>
<a href="http://www.postgis.fr/">PostGIS</a>
</li>
<li>
<a href="http://www.postgresql.org/docs/techdocs">Techdocs</a>
</li>
<li>
<a href="http://www.varlena.com/varlena/GeneralBits/Tidbits/">General TidBits</a>
</li>
<p><!--</p>
<li>
<a href="http://www.postgresqlfr.org/?q=node/view/58">Version Windows</a>
</li>
<p>--></p>
<li>
<a href="http://www.postgresqlfr.org/drupal/?q=node/view/63">T√©moignages de pros</a>
</li>
<li>
<a href="http://archives.postgresql.org/pgsql-fr-generale/">Liste de diffusion</a>
</li>
<li>
<a href="http://wwwmaster.postgresql.org/download/mirrors-ftp">T√©l√©charger</a>
</li>
</ul>
<p></small></p>

		    </div></div></div>
<div class="block block-block" id="block-block-2">
<div class="pgSideNav">    <h2>Recherche</h2>    
		    <div>
			<form action="http://drupal.postgresql.fr/?q=search" method="post">
<div id="search">
<input class="form-text" type="text" size="15" value="" name="keys" alt="Enter the terms you wish to search for." /><br />
<input class="form-submit" type="submit" value="Recherche" />
</div>
</form>

		    </div></div></div>
<div class="block block-forum" id="block-forum-0">
<div class="pgSideNav">    <h2>Sujets du forum</h2>    
		    <div>
			<div class="item-list"><h3>Sujets actifs</h3><ul><li><a href="index253f.html?q=node/1742">A LIRE : FERMETURE DES FORUMS DRUPAL</a></li><li><a href="indexfc2e.html?q=node/1739" title="2 commentaires">Probl√®me  avec pg_dump</a></li><li><a href="index97c1.html?q=node/1731" title="5 commentaires">Connexions simultann√©es</a></li><li><a href="index32d3.html?q=node/1737" title="1 commentaire">Optimisation de la m√©moire sous PostgreSQL</a></li><li><a href="index2483.html?q=node/1736" title="3 commentaires">[R√©solu] Upgrade Postgre -> types et op√©rateurs</a></li></ul></div><div class="item-list"><h3>Nouveaux sujets:</h3><ul><li><a href="index253f.html?q=node/1742">A LIRE : FERMETURE DES FORUMS DRUPAL</a></li><li><a href="indexfc2e.html?q=node/1739" title="2 commentaires">Probl√®me  avec pg_dump</a></li><li><a href="index32d3.html?q=node/1737" title="1 commentaire">Optimisation de la m√©moire sous PostgreSQL</a></li><li><a href="index2483.html?q=node/1736" title="3 commentaires">[R√©solu] Upgrade Postgre -> types et op√©rateurs</a></li><li><a href="index82c4.html?q=node/1734" title="2 commentaires">[RESOLU] Probleme de connection en odbc</a></li></ul></div><div class="more-link"><a href="index79b7.html?q=forum" title="Lire les derniers sujets.">en lire plus</a></div>
		    </div></div></div>
<div class="block block-archive" id="block-archive-0">
<div class="pgSideNav">    <h2>Acc√©der aux archives</h2>    
		    <div>
			
<!-- calendar -->
<div class="calendar"><table summary="Un calendrier pour acc√©der aux archives.">
 <caption><a href="index9dfb.html?q=archive/2008/09/12" title="Mois pr√©c√©dent">&laquo;</a> Octobre 2008 &nbsp;</caption>
 <tr class="header-week">
 <th abbr="Lundi">Lun</th>
 <th abbr="Mardi">Mar</th>
 <th abbr="Mercredi">Mer</th>
 <th abbr="Jeudi">Jeu</th>
 <th abbr="Vendredi">Ven</th>
 <th abbr="Samedi">Sam</th>
 <th abbr="Dimanche">Dim</th>
</tr>
 <tr class="row-week"><td class="day-blank" colspan="2">&nbsp;</td>
  <td class="day-link"><a href="indexd3e2.html?q=archive/2008/10/1">1</a></td>
  <td class="day-normal">2</td>
  <td class="day-normal">3</td>
  <td class="day-normal">4</td>
  <td class="day-normal">5</td>
 </tr>
 <tr class="row-week">
  <td class="day-normal">6</td>
  <td class="day-normal">7</td>
  <td class="day-normal">8</td>
  <td class="day-normal">9</td>
  <td class="day-normal">10</td>
  <td class="day-normal">11</td>
  <td class="day-today">12</td>
 </tr>
 <tr class="row-week">
  <td class="day-future">13</td>
  <td class="day-future">14</td>
  <td class="day-future">15</td>
  <td class="day-future">16</td>
  <td class="day-future">17</td>
  <td class="day-future">18</td>
  <td class="day-future">19</td>
 </tr>
 <tr class="row-week">
  <td class="day-future">20</td>
  <td class="day-future">21</td>
  <td class="day-future">22</td>
  <td class="day-future">23</td>
  <td class="day-future">24</td>
  <td class="day-future">25</td>
  <td class="day-future">26</td>
 </tr>
 <tr class="row-week">
  <td class="day-future">27</td>
  <td class="day-future">28</td>
  <td class="day-future">29</td>
  <td class="day-future">30</td>
  <td class="day-future">31</td>
  <td class="day-blank" colspan="2">&nbsp;</td>
 </tr>
</table></div>


		    </div></div></div>
<div class="block block-node" id="block-node-0">
<div class="pgSideNav">    <h2>Syndication</h2>    
		    <div>
			<div class="xml-icon"><a href="index9637.html?q=rss.xml"><img src="misc/xml.png" width="36" height="14" alt="Flux XML" title="Flux XML" /></a></div>
		    </div></div></div>
<div class="block block-poll" id="block-poll-0">
<div class="pgSideNav">    <h2>Sondage</h2>    
		    <div>
			<div class="poll"><div class="title">Quelle est la version de PostgreSQL la plus r√©pandue sur vos serveurs ?</div><div class="text">8.3</div><div class="bar"><div style="width: 10%;" class="foreground"></div></div><div class="percent">10%</div><div class="text">8.2</div><div class="bar"><div style="width: 42%;" class="foreground"></div></div><div class="percent">42%</div><div class="text">8.1</div><div class="bar"><div style="width: 40%;" class="foreground"></div></div><div class="percent">40%</div><div class="text">8.0</div><div class="bar"><div style="width: 2%;" class="foreground"></div></div><div class="percent">2%</div><div class="text">7.4</div><div class="bar"><div style="width: 6%;" class="foreground"></div></div><div class="percent">6%</div><div class="text">7.3 ou ant√©rieure</div><div class="bar"><div style="width: 0%;" class="foreground"></div></div><div class="percent">0%</div><div class="total">Nombre de votes: 48</div></div><div class="links"><a href="index8c57.html?q=node/1426#comment" title="Sauter au premier commentaire de ce message.">3 commentaires</a> | <a href="index729f.html?q=poll" title="Voir la liste des sondages de ce site.">anciens sondages</a></div>
		    </div></div></div>
    </td>

      <td style="vertical-align: top; width: 80%"><div class="breadcrumb"><a href="index03d2.html?q=">Accueil</a></div><h2 class="title">S√©curiser votre base PostgreSQL</h2>
<!-- begin content -->

<!-- node: "S√©curiser votre base PostgreSQL" -->
<!--<div class="pgFrontCenterUser">
<div class="pgFrontUser">
<div class="pgFrontUserInner">
--><div class="pgFrontUserWrap">
 <div class="pgFrontUserContent">	<h1 class="plop"> | <a href="indexc808.html?q=node/1379" class="active">S√©curiser votre base PostgreSQL</a></h1>
		    <p>
			    Par <a href="indexc818.html?q=user/3" title="Voir le profil utilisateur.">Guillaume Lelarge</a> le 05/09/2007 - 17:04
		    </p>	
			    <p><i>Article √©crit par <a href="mailto:depesz@depesz.com">Hubert Lubaczewski</a> et traduit par <a href="mailto:damien@dalibo.com">Damien Clochard</a>, le 18 ao√ªt 2007. La <a href="http://www.depesz.com/index.php/2007/08/18/securing-your-postgresql-database/">version originale</a> est disponible sur le <a href="http://www.depesz.com/">blog de l'auteur</a> o√π se trouvent beaucoup d'autres articles int√©ressants.</i></p>
<p>Il y a quelques temps j'ai d√©crit <a href="http://www.depesz.com/index.php/2007/08/12/hacking-with-postgresql/">comment ¬´ <code>pirater<code> ¬ª un syst√®me en utilisant PostgreSQL</a>. Aujourd'hui, je vais d√©crire comment s√©curiser au maximum une installation PostgreSQL1.</p>
<p>Je passerai par diff√©rentes √©tapes, en d√©crivant ce qui est possible, ce qui est simple et ce qui n'est pas si simple :)</p>
<p>Commen√ßons donc le tutoriel...</p>
<p><!-- break --></p>
<p>Tout d'abord, je suppose que vous voulez prot√©ger la base des mauvais agissements d'un utilisateur PostgreSQL. Je n'√©voquerai pas la protection contre les utilisateurs syst√®me ou les administreurs.</p>
<p>La premi√®re chose √† faire consiste √† interdire les connexions distantes pour les super-utilisateurs. C'est une modification basique qui se fait simplement.</p>
<p>Cherchons tout d'abord le fichier <cite>pg_hba.conf</cite>. Sur mon syst√®me, il se trouve dans <cite>/home/pgdba/data/pg_hba.conf</cite>. Sur le v√¥tre, il est certainement ailleurs. Vous pouvez v√©rifier son emplacement en ex√©cutant cette requ√™te&nbsp;:</p>
<p class="code">
# show hba_file ;<br />
hba_file<br />
------------------------------<br />
/home/pgdba/data/pg_hba.conf<br />
(1 row)
</p>
<p>Bien. Maintenant, voici le contenu de ce fichier sur ma machine&nbsp;:</p>
<p class="code">
local all all trust<br />
host all all 127.0.0.1/32 trust<br />
host all all ::1/128 trust<br />
host all all 0.0.0.0/0 md5
</p>
<p>Si vous ne comprenez pas ce que cela signifie, consultez le <a class="reference" href="http://docs.postgresqlfr.org/8.2/client-authentication.html#auth-pg-hba-conf">manuel</a>.</p>
<p>Maintenant, pour certaines raisons, j'ai trois comptes super-utilisateurs<br />
sur la machine&nbsp;: <cite>pgdba</cite>, <cite>postgres</cite> et <cite>depesz</cite>. Nous allons effectuer les modifications afin que ces comptes ne puissent √™tre utilis√©s que par connexion locale (socket unix) et en fournissant un mot de passe. Toute autre tentative de connexion √† ces comptes sera interdite.</p>
<p>Voici le nouveau fichier <cite>pg_hba.conf</cite>&nbsp;:</p>
<p class="code">
local all &#64;admins md5<br />
local all all trust<br />
host all &#64;admins 0.0.0.0/0 reject<br />
host all all 127.0.0.1/32 trust<br />
host all all ::1/128 trust<br />
host all all 0.0.0.0/0 md5
</p>
<p>Je viens √©galement de cr√©er un nouveau fichier, /home/pgdba/data/admins</p>
<p class="code">
depesz<br />
pgdba<br />
postgres
</p>
<p>Remarque&nbsp;: N'oubliez pas qu'apr√®s chaque modification de votre fichier <cite>pg_hba.conf</cite>, vous devez red√©marrer le serveur.</p>
<p>Comme nous le voyons clairement, le fichier <cite>admins</cite> contient les noms des trois utilisateurs auxquels je souhaite limiter l'acc√®s.</p>
<p>Lorsque PostgreSQL v√©rifie le fichier <cite>pg_hab.conf</cite>, il s'arr√™te √† la premi√®re ligne pertinente. Ainsi il est n√©cessaire de placer la ligne <cite>local all all trust</cite> <em>apr√®s</em> la ligne concernant le groupe d'administrateur ( <cite>local all &#64;admins md5</cite> ). Cependant, si l'on changeait l'ordre de la mani√®re suivante :</p>
<p class="code">
local all all trust<br />
local all &#64;admins md5<br />
host all &#64;admins 0.0.0.0/0 reject<br />
...
</p>
<p>alors tous les utilisateurs seraient autoris√©s √† se connecter sur n'importe quel compte PostgreSQL. Ceci serait regrettable donc soyez prudent en configurant le fichier <cite>pg_hba.conf</cite></p>
<p>Certaines personnes (notamment celles qui utilisent debian) sont fans de l'authentification <cite>ident sameuser</cite>. Les mots me manquent pour dire √† quel point je d√©teste cela. Je ne vais pas rentrer dans les d√©tails mais ce que je peux vous dire, c'est que j'utilise <cite>trust</cite> sur ma machine de d√©veloppement (ordinateur portable) et uniquement <cite>md5</cite> sur les serveurs de production. Je pense que l'authentification <cite>ident</cite> peut √™tre utile dans certains cas, mais je n'ai pas trouv√© lesquels. Pour le moment.</p>
<p>Bref, la premi√®re √©tape √©tait relatiment simple : nous avons prot√©ger la base contre des utilisateurs inopportuns qui voudraient se connecter en tant que super-utilisateurs (√† distance, tout du moins).</p>
<p>Avant de poursuivre, √©voquons les outils nomm√©s <cite>dblink</cite> et <cite>dbilink</cite>. Souvenez-vous qu'utiliser ces modules abaissent la s√©curit√© de votre syst√®me car ils modifient l'adresse IP depuis laquelle vous vous connectez. Je ne dis pas que ces modules sont mauvais : ils sont parfaitement sains, mais leur utilisation impose de r√©fl√©chir en pr√©alable aux implications en terme de s√©curit√©.</p>
<p>Revenons maintenant √† notre tutoriel.</p>
<p>Nous avons notre base super top-secr√®te qui contient les orientations sexuelles de tout le monde. Nous ne voulons pas que n'importe quel utilisateur Postgres se connecte √† la base √† l'exception des utilisateurs d√©di√©s (via une application web).</p>
<p>Comment faire ?</p>
<p>Revenons simplement au fichier pg_hba.conf et modifions-le :</p>
<p class="code">
local all &#64;admins md5<br />
local secret webapp md5<br />
local secret all reject<br />
local all all trust<br />
host all &#64;admins 0.0.0.0/0 reject<br />
host all all 127.0.0.1/32 trust<br />
host all all ::1/128 trust<br />
host all all 0.0.0.0/0 md5
</p>
<p>Avec les lignes 2 et 3 (avec le mot 'secret'), j'autorise l'utisateur <cite>webapp</cite> √† se connecter √† la base <cite>secret</cite> en mode <cite>md5</cite> et je rejette toutes les autres connections.</p>
<p>Il est important de laisser <cite>local all &#64;admins md5</cite> en premi√®re ligne. En effet, si je pla√ßais cette ligne apr√®s la ligne <cite>local secret all reject</cite>, cela interdirait les connexions super-utilisateurs.</p>
<p>Th√©oriquement, cette configuration semble correcte, mais vous devez proc√©der √† deux configurations :</p>
<blockquote>
<ol class="arabic simple">
<li>Un compte super-utilisateur est √©quivalent √† un acc√®s shell, donc quelqu'un avec ce niveau d'acc√®s pourrait modifier le fichier pg_hba.conf et recharger la configuration du serveur. Donc il n'y a pas de protection contre les super-utilisateurs.</li>
<li>D√©sactiver les acc√®s super-utilisateurs implique que chaque fois que vous ex√©cuterez des op√©rations de haut niveau (ajout d'un nouveau langage, ajout de fonctions C), vous devrez modifier le fichier pg_hba.conf, ce qui augmente le risque d'erreur.</li>
</ol>
</p></blockquote>
<p>Pour ma part, je pense que laisser un acc√®s aux super-utilisateurs est une bonne chose.</p>
<p>Maintenant, lorsque je tente de me connecter avec un autre utilisateur (disons l'utilisateur <cite>test</cite>), la connexion est rejet√©e :</p>
<p class="code">
=&gt; psql -U test -d secret<br />
psql: FATAL: no pg_hba.conf entry for host &quot;[local]&quot;, user &quot;test&quot;,<br />
database &quot;secret&quot;, SSL off
</p>
<p>Parfait. Personne ne peut se connecter √† la base, √† l'exception d'un utilisateur pr√©cis (<cite>webapp</cite>). Mais voici un probl√®me : si quelqu'un obtenait l'acc√®s √† ce compte <cite>webapp</cite>, il/elle pourrait faire ce qu'il/elle veut. Supprimer des tables ? Pas de probl√®me. Vider des tables ? Pas de probl√®me. Mettre √† jour ? ins√©rer des donn√©es ? tout cela fonctionnera.</p>
<p>Nous ne pouvons retirer ses droits au propr√©taires des tables. Donc nous allons avoir besoin d'un utilisateur suppl√©mentaire. Cr√©ons un utilisateur <cite>admin</cite> (qui ne serait pas super-utilisateur mais simplement administrateur de la base). L'utilisateur <cite>webapp</cite> sera d√©di√© √† l'application web et aura des droits restreints.</p>
<p>Nous devons alors :</p>
<blockquote>
<ul class="simple">
<li>cr√©er l'utilisateur <cite>admin</cite></li>
<li>d√©clarer <cite>admin</cite> propri√©taire de tous les objets de la base</li>
<li>donner √† <cite>admin</cite> la possibilit√© de se connecter</li>
<li>accorder et r√©voquer certains droits √† <cite>webapp</cite></li>
</ul>
</p></blockquote>
<p>Cela semble simple. La commande <cite>create user</cite> est triviale. Le changement de propri√©taire est fastidieux mais simple. Attribuer les droits d'administration requiert simplement d'ajouter la ligne suivant dans le fichier <cite>pg_hba.conf</cite> :</p>
<p class="code">
local secret admin md5
</p>
<p>avant la ligne :</p>
<p class="code">
local secret all reject
</p>
<p>(et bien s√ªr red√©marrer le serveur).</p>
<p>Maintenant, passons √† la partie revoke/grant :)</p>
<p>Notre base a une table (et une sequence) :</p>
<p class="code">
&gt; \d<br />
List of relations<br />
Schema  | Name         | Type     | Owner<br />
--------+--------------+----------+-------<br />
public  | users        | table    | admin<br />
public  | users_id_seq | sequence | admin<br />
(2 rows)<br />
&nbsp;<br />
&gt;\d users<br />
Table &quot;public.users&quot;<br />
Column         | Type    | Modifiers<br />
---------------+---------+----------------------------------------------------<br />
id             | integer | not null default nextval('users_id_seq'::regclass)<br />
username       | text    | not null<br />
sex_preference | text    |<br />
Indexes:<br />
&quot;users_pkey&quot; PRIMARY KEY, btree (id)<br />
&quot;users_username_key&quot; UNIQUE, btree (username)<br />
&nbsp;<br />
&gt; select * from users;<br />
id  | username | sex_preference<br />
----+----------+----------------<br />
&nbsp;&nbsp;1 | aa       | qqq<br />
&nbsp;&nbsp;2 | bb       | www<br />
&nbsp;&nbsp;3 | cc       | eee<br />
(3 rows)
</p>
<p>Rien de bien passionant, juste quelques donn√©es de test.</p>
<p>Bien s√ªr, maintenant, <cite>webapp</cite> ne peut plus rien lire dans la table <cite>users</cite> :</p>
<p class="code">
(webapp&#64;[local]:5830) 22:56:51 [secret]<br />
&gt; select * from users;<br />
ERROR: permission denied for relation users
</p>
<p>Maintenant, le probl√®me est qu'un utilisateur malveillant peut (par exemple) cr√©er une table et la remplir al√©atoirement, juste pour planter PostgreSQL.</p>
<p>La solution est simple :</p>
<blockquote>
<ul class="simple">
<li>se connecter √† la base <cite>secret</cite> en tant que super-utilisateur</li>
<li>r√©voquer les droits de cr√©ation au groupe <cite>public</cite> (le groupe qui contient tout les utilisateurs.</li>
<li>accorder les droits de cr√©ation √† l'utilisateur <cite>admin</cite></li>
</ul>
</p></blockquote>
<p>Ce qui nous donne :</p>
<p class="code">
(admin&#64;[local]:5830) 23:12:06 [secret]<br />
&nbsp;<br />
&gt; \c - depesz<br />
Password for user &quot;depesz&quot;:<br />
You are now connected to database &quot;secret&quot; as user &quot;depesz&quot;.<br />
(depesz&#64;[local]:5830) 23:12:10 [secret]<br />
&nbsp;<br />
# revoke create on schema public from public;<br />
REVOKE<br />
(depesz&#64;[local]:5830) 23:12:15 [secret]<br />
&nbsp;<br />
# grant create on schema public to admin;<br />
GRANT<br />
(depesz&#64;[local]:5830) 23:12:24 [secret]<br />
&nbsp;<br />
# \c - admin<br />
Password for user &quot;admin&quot;:<br />
You are now connected to database &quot;secret&quot; as user &quot;admin&quot;.
</p>
<p>Il est n√©cessaire de se connecter √† un compte super-utilisateur car le sch√©ma <cite>public</cite> appartient aux super-utilisateurs et non pas au propri√©taire de la base.</p>
<p>OK. R√©sumons la situation :</p>
<blockquote>
<ol class="arabic simple">
<li>Les super-utilisateurs peuvent se connecter uniquement via sockets unix, c'est-√†-dire uniquement en local.</li>
<li>Seuls deux utilisateurs peuvent se connecter √† la base <cite>secret</cite> : <cite>admin</cite> et <cite>webapp</cite>.</li>
<li>L'utilisateur <cite>admin</cite> peut faire ce qu'il veut</li>
<li>L'utilisateur <cite>webapp</cite> peut se connecter et c'est √† peu pr√®s tout. Il peut voir les noms des tables mais ne peut ni cr√©er des tables, ni s√©lectionner/ins√©rer/modifier/supprimer des donn√©es dans les tables existantes.</li>
</ol>
</p></blockquote>
<p>Nous souhaitons maintenant que l'utilisateur <cite>webapp</cite> puisse lire les donn√©e. Nous pourrions faire quelque chose comme :</p>
<p class="code">
grant select on table users to webapp;
</p>
<p>Mais ce n'est pas tr√®s cool. Les donn√©es de la table <cite>users</cite> sont tr√®s sensibles et nous ne voulons pas que l'utilisateur puisse √©xecuter la commande : <cite>select * from users;</cite> et ainsi obtenir des informations sur la sexualit√© de millions de personnes. Nous voulons que l'utilisateur <cite>webapp</cite> soit capable de lire les donn√©e pour un utilisateur pr√©cis (les op√©rations INSERT, UPDATE et DELETE ne seront pas √©voqu√©es car la m√©thode est tr√®s similaire)</p>
<p>Comment pouvons-nous r√©aliser cela ? Avec les proc√©dures stock√©es bien s√ªr. Connectez-vous sur le compte <cite>admin</cite> et cr√©ez une fonction :</p>
<p class="code">
CREATE OR REPLACE FUNCTION get_user_record(in_user TEXT) RETURNS setof<br />
users as $BODY$<br />
DECLARE<br />
temprec users;<br />
BEGIN<br />
for temprec in SELECT * FROM users WHERE username = in_user LOOP<br />
RETURN next temprec;<br />
END loop;<br />
RETURN;<br />
END;<br />
$BODY$ language plpgsql SECURITY DEFINER;
</p>
<p>Cependant, puisque la fonction est √©crite en <cite>plpgsql</cite>, elle est disponible par d√©faut pour tout le monde. Am√©liorons la s√©curit√©  :</p>
<p class="code">
(admin&#64;[local]:5830) 23:24:21 [secret]<br />
&gt; revoke execute on function get_user_record (text) from public;<br />
REVOKE<br />
&nbsp;<br />
(admin&#64;[local]:5830) 23:26:00 [secret]<br />
&gt; grant execute on function get_user_record(text) to webapp;<br />
GRANT
</p>
<p>D√©sormais notre utilisateur <cite>webapp</cite> peut appeler la fonction en donnant le nom exact qu'il recherche :</p>
<p class="code">
(webapp&#64;[local]:5830) 23:26:10 [secret]<br />
&gt; select * from get_user_record('aa');<br />
id | username | sex_preference<br />
---+----------+----------------<br />
1  | aa       | qqq<br />
(1 row)
</p>
<p>mais il ne pourra pas obtenir tous les enregistrement de la table.</p>
<p>Ce qui est plus important : pour que la fonction soit fonctionnelle, nous n'avons pas besoin de d'autoriser la selection (<cite>grant select</cite>) sur la table <cite>users</cite> pour l'utilisateur <cite>webapp</cite>. Ce tour de magie est op√©r√© par la d√©claration du gestionnaire de s√©curit√© ( <cite>SECURITY DEFINER</cite> ) dans la d√©finition de la fonction.</p>
<p>Si vous n'√™tes pas familier avec cette fonctionnalit√©, sachez qu'elle fonctionne plus ou moins comme <cite>suid</cite> sur les syst√®mes UNIX. Tous les utilisateurs appelant la fonction seront vus par PostgreSQL comme l'utilisateur qui a cr√©√© la fonction.</p>
<p>Ce qui nous am√®ne aux recommandation suivantes :</p>
<blockquote>
<ul class="simple">
<li>Vous devez √™tre tr√®s prudent en √©crivant des functions &quot;<cite>security definer</cite>&quot;. Cela a √©t√© longtemps discut√© et la conclusion est que dans une base ouverte (o√π les simples utilisateurs peuvent cr√©er des objets), les fonctions &quot;<cite>security definer</cite>&quot; peuvent √™tre utilis√©es pour contourner les limitations.</li>
<li>Si vous utilisez <cite>current_user</cite> pour quoi que ce soit, cela ne fonctionnera pas. Vous obtiendrez invariablement le nom du cr√©ateur de la fonction.</li>
</ul>
</p></blockquote>
<p>Dans notre situation, tout est bon : <cite>webapp</cite> ne pourra pas cr√©er ses propres objets, ainsi il ne sera pas capable d'utiliser la fonction pour pirater la base, de plus  <cite>current_user</cite> n'est pas r√©ellement utile dans une base qui ne poss√®de que deux utilisateurs :)</p>
<p>Les fonctions &quot;<cite>security definer</cite>&quot; peuvent aussi d√©finir des op√©rations INSERT/UPDATE/DELETE, qui feront les v√©rifications de param√®tres n√©cessaires et ex√©cuteront les actions requises, √©ventuellement acommpagn√©es par des traitements connexes, tel que le changement de login, la sauvegarde, la d√©normalisation et ainsi de suite.</p>
<p>Une derni√®re point √† aborder : l'utilisateur <cite>webapp</cite> peut voir les noms des tables. Personnellement, cela ne me d√©range pas, mais certaines personne peuvent souhaiter cacher les noms d'objets. Je n'ai pas vraiment creuser ce point, mais cela parait simple √† faire. Cette fois, nous allons modifier les droits du schema <cite>pg_catalog</cite> :</p>
<p class="code">
(admin&#64;[local]:5830) 23:36:17 [secret]<br />
&gt; \c - depesz<br />
Password for user &quot;depesz&quot;:<br />
You are now connected to database &quot;secret&quot; as user &quot;depesz&quot;.<br />
&nbsp;<br />
(depesz&#64;[local]:5830) 23:36:21 [secret]<br />
# revoke usage on schema pg_catalog from public;<br />
REVOKE<br />
&nbsp;<br />
(depesz&#64;[local]:5830) 23:36:27 [secret]<br />
# grant usage on schema pg_catalog to admin;<br />
GRANT<br />
&nbsp;<br />
(depesz&#64;[local]:5830) 23:36:38 [secret]<br />
# \c - admin<br />
Password for user &quot;admin&quot;:<br />
You are now connected to database &quot;secret&quot; as user &quot;admin&quot;.
</p>
<p>(notez bien qu'il existe aussi un sch√©ma d'informations, qui devra √™tre modifi√© de la m√™me fa√ßon, sinon il suffira d'interroger les tables et des vues du sch√©ma <cite>information_schema</cite> pour obtenir les noms des objets !).</p>
<p>Apr√®s ceci, l'utilisateur <cite>admin</cite> peut toujours travailler commme avant tandis que l'utilisateur <cite>webapp</cite> est contraint √† certaines limitations :</p>
<p class="code">
(webapp&#64;[local]:5830) 23:34:49 [secret]<br />
&gt; \d<br />
ERROR: permission denied for schema pg_catalog<br />
&nbsp;<br />
(webapp&#64;[local]:5830) 23:37:41 [secret]<br />
&gt; select * from get_user_record('aa');<br />
id  | username | sex_preference<br />
----+----------+----------------<br />
&nbsp;&nbsp;1 | aa | qqq<br />
(1 row)<br />
&nbsp;<br />
(webapp&#64;[local]:5830) 23:37:46 [secret]<br />
&gt; \df+ get_user_record<br />
ERROR: permission denied for schema pg_catalog<br />
(webapp&#64;[local]:5830) 23:37:52 [secret]<br />
&gt; \df get_user_record<br />
ERROR: permission denied for schema pg_catalog
</p>
<p>Comme vous pouvez le voir, l'utilisateur <cite>webapp</cite> ne peut pas voir la liste des tables, mais il est capable d'appeler la fonction <cite>get_user_record()</cite>. Par ailleurs, ce qui est important, c'est qu'il<br />
n'est pas capable de voir le code source de la fonction, ni m√™me les informations comme le nombre d'arguments.</p>
<p>Il est possible dans certains cas que r√©voquer les droits du sch√©ma <cite>pg_catalog</cite> provoque de mauvais r√©sultats, mais (comme vous le constatez dans l'exemple ci-dessus) cela fonctionne et c'est assez simple √† mettre en place.</p>
<p>R√©capitulons √† nouveau ce que nous avons accompli :</p>
<blockquote>
<ol class="arabic simple">
<li>Les super-utilisateurs peuvent se connecter uniquement via sockets unix, c'est-√†-dire uniquement en local.</li>
<li>Seuls deux utilisateurs peuvent se connecter √† la base <cite>secret</cite> : <cite>admin</cite> et <cite>webapp</cite>.</li>
<li>L'utilisateur <cite>admin</cite> peut faire ce qu'il veut</li>
<li>L'utilisateur <cite>webapp</cite> peut se connecter √† la base</li>
<li>L'utilisateur <cite>webapp</cite> ne peut pas voir les noms des objets (tables, vues, fonctions) ni leurs d√©finitions.</li>
<li>L'utilisateur <cite>webapp</cite> ne peut pas interroger les tables directement.</li>
<li>L'utilisateur <cite>webapp</cite> a acc√®s aux donn√©es via des fonctions qui impliquent des v√©rifications de donn√©es.</li>
</ol>
</p></blockquote>
<p>Pour finir, voici quelques remarques :</p>
<p>1. En dehors des fonctions, les vues permettent √©galement de limiter les droits d'acc√®s : l'utilisateur n'a pas acc√®s √† la table mais a une vue batie sur celle-ci, ce qui permet de proposer une vue qui ne montre qu'une seule colonne de la table. Je n'en ai pas discut√© ici car les vues n'ont pas la m√™me flexibilit√© que les fonctions. De plus, dans les nouvelles versions de PostgreSQL, les fonctions sont presque aussi rapides que les vues.</p>
<p>2. Si vous avez d√©j√† tout construit avec des fonctions, vous √™tes pr√™t √† utiliser l'outil <cite>pl/proxy</cite> pour effectuer de la r√©partition de charge (load-balancing).</p>
<p>3. Th√©oriquement on peut supposer qu'un utilisateur malveillant pourrait appeler la fonction get_user_record avec tous les noms possibles. C'est vrai, mais puisque nous pouvons √©crire ce que nous voulons dans la fonction, il est assez simple de programmer la fonction afin qu'elle se bloque apr√®s le 3√®me appel infructueux ou avertir l'administrateur par e-mail ou ex√©cuter la commande <cite>pg_ctl stop</cite> pour emp√™cher imm√©diatement tout perte de donn√©es :)</p>
<p>4. Quand une base est prot√©g√©e et en s√©curit√©, souvenez-vous des sauvegardes. Je ne parle pas de sauvegarder la base. je parle de sauvegarder la base en toute s√©currit√©. Ne faites pas un simple dump de la base dans un fichier que vous entreposerez ailleurs. Chiffrer le fichier dump : au moins en utilisant &quot;zip -e&quot; au mieux avec gpg/pgp.</p>

		     </div></div>
<!--</div>
</div>
</div>
</div> -->
<a id="comment"></a>
<form method="post" action="http://drupal.postgresql.fr/?q=comment"><div>
<input type="hidden" name="edit[nid]" value="1379" />
</div></form>
<!-- end content -->
              </td>

    </tr>
    <tr><td colspan="2">

		<div class="pgTopNav">
		   <div class="pgTopNavLeft"> 
		     <img src="layout/images/nav_lft.png" width="7" height="23" alt="" />
		   </div>
		   <div class="pgTopNavRight">
		    <img src="layout/images/nav_rgt.png" width="7" height="23" alt="" />
		  </div>
		  <!--<ul class="pgTopNavList">-->
		  <ul class="pgTopNavList">
		   <li><a href="index03d2.html?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="indexf6e5.html?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="index71c4.html?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>

		   <li> <a href="indexf6fe.html?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="index79b7.html?q=forum">forums</a> </li>
		   <li> <a href="index729f.html?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="index4404.html?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>

		  </ul>

<!--
		   <li><a href="?q=" title="Retourner √† la page principale.">accueil</a> </li>
		   <li> <a href="?q=archive" title="Lire le contenu plus ancien dans notre archive.">archives</a> </li>
		   <li> <a href="?q=blog" title="Lire les blogues les plus r√©cents.">blogues</a> </li>
		   <li> <a href="?q=book" title="Lire et contribuer aux livres collaboratifs.">livres</a> </li>
		   <li> <a href="?q=forum">forums</a> </li>
		   <li> <a href="?q=poll" title="Voir la liste des sondages de ce site.">sondages</a> </li>
		   <li> <a href="?q=search" title="Chercher pour du contenu plus vieux.">recherche</a></li><li><a href="http://docs.postgresqlfr.org/" target="_blank">documentation </a></li>
-->
		  </ul>
	        </div>
    </td></tr>
   </table>
   <p style="text-align: center;">&copy;&nbsp;PostgreSQLFr, tous droits r√©serv√©s.<br>
Site d√©clar√© √† la CNIL sous le num√©ro 1074678, conform√©ment √† la Loi en vigueur.
</p>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-3921927-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>
<p></p>
   
</body>

<!-- Mirrored from drupal.postgresql.fr/?q=node/1379 by HTTrack Website Copier/3.x [XR&CO'2006], Sun, 12 Oct 2008 16:31:14 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>